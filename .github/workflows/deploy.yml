name: Deploy to Azure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install Root Dependencies
      run: npm install

    - name: Install Client Dependencies
      working-directory: ./client
      run: npm install

    - name: Install Server Dependencies
      working-directory: ./server
      run: npm install

    - name: Build Client
      working-directory: ./client
      run: npm run build
      env:
        CI: true
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}

    - name: Run Tests
      run: |
        NODE_ENV=test npm test
      env:
        CI: true

    - name: Prepare for Deployment
      run: |
        mkdir -p dist
        cp -r server/* dist/
        cp -r client/build dist/client/build
        cp package.json dist/
        cp .deployment dist/

    - name: Deploy to Azure
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: dist
      env:
        NODE_ENV: production